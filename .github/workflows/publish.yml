name: Godot Pages

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

env:
  GODOT_MAJOR_MINOR_VERSION: "4.2.1"  # Din Godot versjon (se "About Godot")
  PROJECT_FOLDER: "demo_project"  # Mappesti fra GitHub repo root
  EXPORT_PRESET_NAME: HTML5  # Navn pÃ¥ Web Export Preset

  # Skal ikke trenge Ã¥ rÃ¸re disse
  EXPORT_TEMPLATE: release
  EXPORT_FOLDER: build/
  EXPORT_FILENAME: index.html
jobs:
  godot_pages:
    runs-on: ubuntu-latest
    name: Godot Pages

    steps:
    - name: "Set environmental variables"
      # If you have a custom godot you may want to modify the urls to download your own godot and templates
      run: |
        echo "GODOT_VERSION=${GODOT_MAJOR_MINOR_VERSION}" >> $GITHUB_ENV
        echo "GODOT_EXECUTABLE_DOWNLOAD_URL=https://downloads.tuxfamily.org/godotengine/${GODOT_MAJOR_MINOR_VERSION}/Godot_v${GODOT_MAJOR_MINOR_VERSION}-stable_linux.x86_64.zip" >> $GITHUB_ENV
        echo "GODOT_TEMPLATES_DOWNLOAD_URL=https://downloads.tuxfamily.org/godotengine/${GODOT_MAJOR_MINOR_VERSION}/Godot_v${GODOT_MAJOR_MINOR_VERSION}-stable_export_templates.tpz" >> $GITHUB_ENV
    - name: Checkout
      uses: actions/checkout@v3

    - name: Install Godot
      run: |
        # Download godot executable and templates
        curl ${GODOT_EXECUTABLE_DOWNLOAD_URL} --output godot.zip
        curl ${GODOT_TEMPLATES_DOWNLOAD_URL} --output templates.tpz
        unzip godot.zip -d godot
        unzip templates.tpz

        mkdir -v -p ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
        
        mv templates/* ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
        mv godot/Godot* ${GITHUB_WORKSPACE}/godot.x86_64
        # Just cleaning
        rm -R templates/
        rm templates.tpz

    - name: Build Project
      run: |
        mkdir -v -p ${GITHUB_WORKSPACE}/${EXPORT_FOLDER}
        cd ${PROJECT_FOLDER}
        # Exporting the game
        ${GITHUB_WORKSPACE}/godot.x86_64 --headless --path . --export-${EXPORT_TEMPLATE} ${EXPORT_PRESET_NAME} ${GITHUB_WORKSPACE}/${EXPORT_FOLDER}/${EXPORT_FILENAME}

    # Workaround Cross-origin Isolation (COOR & COEP)
    - name: Add coi-service-worker
      run: |
        git clone https://github.com/gzuidhof/coi-serviceworker.git
        mv coi-serviceworker/coi-serviceworker.js ${EXPORT_FOLDER}/coi-serviceworker.js
        sed -i 's#\(		<script src="index.js"></script>\)#		<script src="coi-serviceworker.js"></script>\n\1#g' ${EXPORT_FOLDER}/index.html

    - name: Upload Artifact
      uses: actions/upload-pages-artifact@v1
      with:
        name: github-pages
        path: ${{ env.EXPORT_FOLDER }}

    - name: Deploy to GitHub Pages ðŸš€
      id: deployment
      uses: actions/deploy-pages@v1
